<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Connection Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #1a1a2e;
        color: #fff;
      }
      .status {
        padding: 20px;
        margin: 10px 0;
        border-radius: 8px;
        font-weight: bold;
      }
      .connected {
        background: #10b981;
      }
      .disconnected {
        background: #ef4444;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        background: #6366f1;
        color: white;
        font-size: 16px;
      }
      button:hover {
        background: #4f46e5;
      }
      #log {
        background: #0f172a;
        padding: 20px;
        border-radius: 8px;
        height: 400px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid #6366f1;
        padding-left: 10px;
      }
      .log-success {
        border-left-color: #10b981;
      }
      .log-error {
        border-left-color: #ef4444;
      }
      .log-info {
        border-left-color: #3b82f6;
      }
    </style>
  </head>
  <body>
    <h1>üîå WebSocket Connection Test</h1>

    <div id="status" class="status disconnected">‚ùå Disconnected</div>

    <div>
      <button onclick="testConnection()">Connect</button>
      <button onclick="testMessage()">Send Test Message</button>
      <button onclick="clearLog()">Clear Log</button>
    </div>

    <h3>Connection Log:</h3>
    <div id="log"></div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
      let socket = null;

      function log(message, type = "info") {
        const logDiv = document.getElementById("log");
        const entry = document.createElement("div");
        entry.className = `log-entry log-${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      function updateStatus(connected) {
        const statusDiv = document.getElementById("status");
        if (connected) {
          statusDiv.className = "status connected";
          statusDiv.textContent = "‚úÖ Connected";
        } else {
          statusDiv.className = "status disconnected";
          statusDiv.textContent = "‚ùå Disconnected";
        }
      }

      function testConnection() {
        log("Attempting to connect to WebSocket server...", "info");

        socket = io({
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionDelayMax: 5000,
          transports: ["websocket", "polling"],
          timeout: 10000,
        });

        socket.on("connect", () => {
          log("‚úÖ Successfully connected to server!", "success");
          log(`Socket ID: ${socket.id}`, "info");
          updateStatus(true);
        });

        socket.on("disconnect", (reason) => {
          log(`‚ùå Disconnected from server. Reason: ${reason}`, "error");
          updateStatus(false);
        });

        socket.on("connect_error", (error) => {
          log(`‚ùå Connection error: ${error.message}`, "error");
          updateStatus(false);
        });

        socket.on("profile_required", (data) => {
          log(`‚ÑπÔ∏è Profile required: ${JSON.stringify(data)}`, "info");
        });

        socket.on("message", (data) => {
          log(`üì© Message received: ${JSON.stringify(data)}`, "success");
        });

        socket.on("chat_history", (data) => {
          log(
            `üìú Chat history received: ${data.messages.length} messages`,
            "success"
          );
        });

        socket.on("members_update", (data) => {
          log(`üë• Members update: ${data.members.length} members`, "info");
        });
      }

      function testMessage() {
        if (!socket || !socket.connected) {
          log("‚ùå Not connected! Click Connect first.", "error");
          return;
        }

        const testMsg = {
          message: "Test message from connection tester",
          crc: "TEST1234",
          username: "Tester",
          photo: null,
          timestamp: new Date().toISOString(),
        };

        log(`üì§ Sending test message...`, "info");
        socket.emit("send_message", testMsg);
      }

      function clearLog() {
        document.getElementById("log").innerHTML = "";
        log("Log cleared", "info");
      }

      // Auto-connect on load
      window.onload = () => {
        log(
          'Page loaded. Click "Connect" to test WebSocket connection.',
          "info"
        );
      };
    </script>
  </body>
</html>
